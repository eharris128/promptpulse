# PromptPulse - Claude Code Usage Tracking & Team Collaboration Platform

## Overview
Multi-user platform for tracking and analyzing Claude Code usage across multiple machines. Features automatic data collection, user authentication, team collaboration, and a beautiful web dashboard for visualizing usage patterns and team leaderboards.

## Key Features
- Multi-user support with API key authentication
- **Team collaboration** - create teams and compare usage with colleagues
- **Team leaderboards** - compete within teams with role-based permissions
- Beautiful dashboard built with Next.js and Recharts
- Multi-machine tracking - aggregate usage across all devices
- Automatic collection via cron job configuration
- Detailed analytics - daily costs, token usage, session tracking
- Project-based insights and cost tracking
- Granular email preferences with 5 individual notification controls

## Project Structure

### CLI Interface
- `bin/promptpulse.js` - Main CLI entry point
- `lib/` - CLI library code
  - `lib/auth.js` - Authentication utilities and getUserByApiKey
  - `lib/auth-cli.js` - CLI authentication commands (login, logout, whoami)
  - `lib/collect.js` - Data collection logic
  - `lib/config.js` - Configuration management
  - `lib/db-manager.js` - Database connection pooling and retry logic
  - `lib/logger.js` - Winston-based structured logging system
  - `lib/setup.js` - Cron setup utilities
  - `lib/user-cli.js` - User management CLI (deprecated commands)
  - `lib/user-management.js` - User management backend
  - `lib/server-auth.js` - Server-side authentication middleware

### API Server
- `server.js` - Express.js API server with authentication and team management
- `migrations/` - Modular database schema migrations
  - `001_create_migrations_table.sql` - Migration tracking table
  - `002_create_users_table.sql` - KSUID-based users with secure API keys
  - `003_create_usage_tables.sql` - Usage data, sessions, blocks, upload history
  - `004_create_email_tables.sql` - Granular email preferences and send logging
  - `005_create_teams_tables.sql` - KSUID teams with member roles and invitations
  - `006_restore_invite_codes.sql` - Simple team invite code system

### Web Dashboard
- `client/` - Next.js dashboard application with team management
  - `client/src/app/` - Next.js app directory
    - `client/src/app/page.tsx` - Dashboard home page
    - `client/src/app/leaderboard/page.tsx` - Public leaderboard view
    - `client/src/app/teams/page.tsx` - Team management and team leaderboards
    - `client/src/app/teams/join/[token]/page.tsx` - Team invite acceptance
    - `client/src/app/settings/page.tsx` - Settings with email preferences
    - `client/src/app/layout.tsx` - Root layout
  - `client/src/components/` - React components
    - `client/src/components/auth/login-form.tsx` - Authentication form
    - `client/src/components/dashboard/` - Dashboard components
      - `stats-cards.tsx` - Usage statistics cards
      - `usage-chart.tsx` - Interactive usage charts
      - `machines-table.tsx` - Machine overview table
      - `team-leaderboard.tsx` - Team-specific leaderboard component
      - `fixed-plan-comparison.tsx` - Plan comparison analytics
    - `client/src/components/layout/` - Layout components
      - `app-layout.tsx` - Main application layout
      - `side-nav.tsx` - Navigation sidebar
      - `top-header.tsx` - Header component
      - `user-menu.tsx` - User account menu
    - `client/src/components/ui/` - UI components
      - `button.tsx`, `card.tsx`, `input.tsx`, etc.
  - `client/src/contexts/auth-context.tsx` - Authentication context
  - `client/src/lib/api.ts` - API client utilities
  - `client/src/types/index.ts` - TypeScript type definitions

## CLI Commands

### Authentication
- `promptpulse login` - Create new account (interactive)
- `promptpulse login <api-key>` - Login with existing API key
- `promptpulse logout` - Clear authentication and log out
- `promptpulse whoami` - Show current user information
- `promptpulse user config show` - Show configuration (debugging)

### Team Management (Dashboard Only)
Team features are accessed through the web dashboard:
- Create and manage teams with custom names and descriptions
- Generate and share team invite links
- Manage team member roles (owner, admin, member)
- View team usage leaderboards and analytics
- Join teams using invite codes

### Data Collection
- `promptpulse collect` - Collect and upload Claude Code usage data
- `promptpulse collect --granularity daily` - Only daily aggregates
- `promptpulse collect --granularity session` - Only session data
- `promptpulse collect --granularity blocks` - Only 5-hour blocks
- `promptpulse collect --granularity all` - Everything (default)

### Setup & Dashboard
- `promptpulse setup` - Set up cron job for automatic collection
- `promptpulse status` - Check collection status and health
- `promptpulse doctor` - Diagnose common collection issues
- `promptpulse dashboard` - Open web dashboard in browser (includes team management)

### Aliases
- `ppulse` - Short alias for `promptpulse`

## API Endpoints

### Authentication Required
All endpoints require `X-API-Key` header with valid API key.

### User Management
- `POST /api/users` - Create new user
- `GET /api/users` - List all users (authenticated)

### Usage Data
- `GET /api/usage/aggregate` - Get aggregated usage data
- `GET /api/machines` - Get user's machines
- `GET /api/usage/sessions?limit=50&projectPath=myproject` - Get sessions
- `GET /api/usage/blocks?activeOnly=true` - Get billing blocks

### Analytics
- `GET /api/usage/analytics/patterns?period=day` - Usage patterns
- `GET /api/usage/analytics/costs?groupBy=project` - Cost breakdown

### Team Management
- `GET /api/teams` - Get user's teams with roles
- `POST /api/teams` - Create new team
- `PUT /api/teams/:id` - Update team details
- `GET /api/teams/:id/members` - Get team members
- `POST /api/teams/:id/members/:userId/promote` - Promote member to admin
- `DELETE /api/teams/:id/members/:userId` - Remove team member
- `POST /api/teams/join/:inviteCode` - Join team via invite code
- `GET /api/teams/:id/leaderboard` - Get team leaderboard data

### Email & Preferences
- `GET /api/email-preferences` - Get user email preferences
- `PUT /api/email-preferences` - Update email notification settings
- `POST /api/send-test-email` - Send test email
- `GET /api/leaderboard-settings` - Get leaderboard participation settings
- `PUT /api/leaderboard-settings` - Update leaderboard and display name settings

## Configuration

### Environment Variables

#### Required
- `DATABASE_URL` - SQLite Cloud connection string

#### Optional Server Configuration
- `MACHINE_ID` - Custom machine identifier (defaults to hostname)
- `PORT` - API server port (defaults to 3000)
- `NODE_ENV` - Environment mode (development/production)

#### Database Connection Pool
- `DB_MAX_CONNECTIONS` - Maximum database connections (default: 10)
- `DB_IDLE_TIMEOUT` - Connection idle timeout in ms (default: 30000)
- `DB_RETRY_ATTEMPTS` - Database retry attempts on failure (default: 3)
- `DB_RETRY_DELAY` - Base retry delay in ms (default: 1000)

#### Logging Configuration
- `LOG_LEVEL` - Logging level: error, warn, info, debug (default: info in production, debug in development)

#### Email Service (Optional)
- `RESEND_API_KEY` - Resend API key for email functionality
- `RESEND_FROM_EMAIL` - From email address for notifications

### User Configuration
- `~/.promptpulse/config.json` - User credentials and settings

### Data Sources
- `~/.claude/projects/**/*.jsonl` - Claude Code usage data files
- `$CLAUDE_CONFIG_DIR/projects/**/*.jsonl` - Alternative path if set

## Database Schema (Modernized)

### Core Tables
- **users**: KSUID-based user IDs with secure API key authentication
- **usage_data**: Daily usage aggregates with token counts and costs
- **usage_sessions**: Individual Claude Code sessions with project paths
- **usage_blocks**: 5-hour billing blocks for cost analysis
- **upload_history**: Deduplication tracking for data uploads

### Email System
- **user_email_preferences**: Granular notification controls (5 separate preferences)
- **email_send_log**: Email delivery tracking and analytics

### Team System (KSUID-based)
- **teams**: Teams with KSUID string IDs, invite codes, and metadata
- **team_members**: Many-to-many relationships with role hierarchy (owner/admin/member)
- **team_invitations**: Secure invitation system with expiring tokens

## Data Flow
1. Collection: CLI reads Claude usage data from ~/.claude/projects/
2. Authentication: User's API key validates requests
3. Storage: Data stored in SQLite Cloud with user isolation and team relationships
4. API: RESTful endpoints serve user-specific and team data
5. Dashboard: React app visualizes usage patterns and team analytics

## Automation Scripts
- Built-in cron configuration via `promptpulse setup` command
- Automatic collection scheduling through CLI

## Key Files
- `package.json` - NPM package configuration with CLI binaries
- `README.md` - Comprehensive documentation
- `scripts/migrate.js` - Database migration runner
- `.npmignore` - Files excluded from NPM package
- `railway.json` - Railway deployment configuration
- `Dockerfile` - Container configuration

## Development
- Node.js 18+ required
- SQLite Cloud or local SQLite database
- Next.js for dashboard development
- Express.js for API server